var V=880,J=640,K=BigInt(6),z=BigInt(7),$=K*z,X=640/Number(K),g=X,F=0;var N=4,Q=5,q=7;class U{static matchTypes;static backGround;static init(){const h=["apple","bread","coconut","green-thing","milk","orange","star"];this.matchTypes=[];for(let w=0;w<q;++w)this.matchTypes.push(new Image),this.matchTypes[w].src=`assets/${h[w]}.png`,this.matchTypes[w].width=Number(X),this.matchTypes[w].height=Number(g);this.backGround=new Image,this.backGround.src="assets/bg.png"}static percentLoaded(){let h=0;for(let w=0;w<q;++w)h+=Number(this.matchTypes[w].complete);return h+=Number(this.backGround.complete),h/(q+1)}}function r(h,w){return Math.floor(Math.random()*(w-h+1)+h)}class Z{b;boards;constructor(){this.b=[];for(let h=0;h<q;++h)this.b.push(BigInt(0))}runSwitch(h,w,u,k){return!1}updateBoard(){if(this.fill())return-1;return this.findConnect3()}getType(h,w){const u=BigInt(1)<<h*z+w;for(let k=0;k<q;++k)if((this.b[k]&u)!=0)return k;return-1}validMoves(){return[]}fill(){let h=!1,w;console.log($);for(let u=$-BigInt(1);u>=0;--u){for(w=BigInt(0);w<q;++w)if((this.b[w]&BigInt(1)<<u)!=0)break;if(w==q)if(h=!0,u%z==0){const k=r(0,Number(q)-1);this.b[k]|=BigInt(1)<<u}else{const k=BigInt(1)<<u-BigInt(1);for(let j=0;j<q;++j)if((this.b[j]&k)!=0){this.b[j]|=BigInt(1)<<u,this.b[j]^=k;break}}}return h}findConnect3(){for(let h=0;h<U.size;++h){const w=this.b[h],u=w&w<<BigInt(7)&w<<BigInt(14),k=w&w<<BigInt(1)&w<<BigInt(2);if(u>0);if(k>0);}return 0}connect3Exists(){return!1}}class O{mouseDown;x;y;downX;downY;upX;upY;shouldHandleMouseEvent;constructor(h){const{offsetLeft:w,offsetTop:u}=h;this.x=0,this.y=0,this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,h.addEventListener("mousemove",(k)=>{this.x=k.x-w,this.y=k.y-u}),h.addEventListener("mousedown",(k)=>{this.downX=Math.floor((k.x-w)/X),this.downY=Math.floor((k.y-u)/g)-1,this.mouseDown=!0}),h.addEventListener("mouseup",(k)=>{this.upX=Math.floor((k.x-w)/X),this.upY=Math.floor((k.y-u)/g)-1,this.shouldHandleMouseEvent=!0,this.mouseDown=!1})}}class L{canvas;ctx;brd;state;score;timeOut;mouse;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${J}`),this.canvas.setAttribute("height",`${V}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new Z,this.state=N,this.score=0,this.timeOut=0,this.mouse=new O(this.canvas)}render(){this.ctx.drawImage(U.backGround,0,0,J,V),this.brd.isDirty=!1;let h,w;for(h=0;h<z;++h)for(w=0;w<K;++w){const k=this.brd.getType(BigInt(w),BigInt(h));if(k==-1)continue;if(this.mouse.mouseDown&&this.mouse.downX==w&&this.mouse.downY==h)continue;this.ctx.drawImage(U.matchTypes[k],w*X,(h+1)*g,X,g)}if(this.mouse.mouseDown)this.ctx.drawImage(U.matchTypes[this.brd.b[this.mouse.downY][this.mouse.downX]],this.mouse.x-X/2,this.mouse.y-g/2,X,g);const u=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(u,J/2.7,g/2)}update(h){switch(this.state){case N:this.checkBoardState();break;case Q:this.timeOutState(h);break;case F:this.playerState();break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}checkBoardState(){const h=this.brd.updateBoard();if(h===0)this.state=F;else this.score+=Math.max(0,h),this.timeOut=25,this.state=Q}timeOutState(h){if(this.timeOut<=0)this.state=N;else this.timeOut-=h}playerState(){if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(this.mouse.downX,this.mouse.downY,this.mouse.upX,this.mouse.upY))this.timeOut=500,this.state=Q}}}(()=>{U.init();const h=()=>{const w=U.percentLoaded();if(w!==1)document.getElementById("progress").value=w,window.requestAnimationFrame(h);else{document.getElementById("progress").hidden=!0;const u=new L;let k=(new Date()).getTime(),j=0;const W=(y)=>{j=y-k,k=y,u.update(j),u.render(),window.requestAnimationFrame(W)};window.requestAnimationFrame(W)}};window.requestAnimationFrame(h)})();
