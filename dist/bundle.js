var Z=880,Q=640,J=6,K=7,z=106.66666666666667,k=106.66666666666667,$=0;var V=4,X=5;class q{static matchTypes;static backGround;static size;static init(){const h=["apple","bread","coconut","green-thing","milk","orange","star"];this.matchTypes=[],this.size=h.length;for(let Y=0;Y<this.size;++Y)this.matchTypes.push(new Image),this.matchTypes[Y].src=`assets/${h[Y]}.png`,this.matchTypes[Y].width=z,this.matchTypes[Y].height=k;this.backGround=new Image,this.backGround.src="assets/bg.png"}static percentLoaded(){let h=0;for(let Y=0;Y<this.size;++Y)if(this.matchTypes[Y].complete)++h;if(this.backGround.complete)++h;return h/(this.size+1)}}class g{b;isDirty;constructor(){this.isDirty=!0,this.b=[];for(let h=0;h<K;++h){let Y=[];for(let w=0;w<J;++w)Y.push(Math.floor(Math.random()*q.size));this.b.push(Y)}}runSwitch(h,Y,w,b){if(h==w&&Math.abs(Y-b)==1||Y==b&&Math.abs(h-w)==1){let j=this.b[Y][h];this.b[Y][h]=this.b[b][w],this.b[b][w]=j;const U=this.connect3Exists();if(!U)j=this.b[Y][h],this.b[Y][h]=this.b[b][w],this.b[b][w]=j;return U}return!1}updateBoard(){if(this.isDirty=!0,this.fill())return-1;return this.findConnect3()}fill(){let h=!1;for(let Y=0;Y<J;++Y)for(let w=K-1;w>=0;--w)if(this.b[w][Y]===-1){if(w===0)this.b[w][Y]=Math.floor(Math.random()*q.size),h=!0;else if(this.b[w-1][Y]!==-1)this.b[w][Y]=this.b[w-1][Y],this.b[w-1][Y]=-1,h=!0}return h}findConnect3(){let h,Y,w,b=0,j=0;for(let U=0;U<K;++U)for(h=0;h<J;++h){if(w=this.b[U][h],w===-1)continue;for(b=0;b+h<J;++b)if(w!==this.b[U][b+h])break;if(b>=3){const P=h+b;for(;h<P;++h)this.b[U][h]=-1;return b}for(b=0;b+U<K;++b)if(w!==this.b[U+b][h])break;if(b>=3){const P=U+b;for(;U<P;++U)this.b[U][h]=-1;return b}}return 0}connect3Exists(){let h,Y,w,b=0;for(let j=0;j<K;++j)for(h=0;h<J;++h){if(w=this.b[j][h],w===-1)continue;for(b=0;b+h<J;++b)if(w!==this.b[j][b+h])break;if(b>=3){const U=h+b;for(;h<U;++h)this.b[j][h]=-1;return!0}for(b=0;b+j<K;++b)if(w!==this.b[j+b][h])break;if(b>=3)return!0}return!1}}class C{mouseDown;x;y;downX;downY;upX;upY;shouldHandleMouseEvent;constructor(h){const{offsetLeft:Y,offsetTop:w}=h;this.x=0,this.y=0,this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,h.addEventListener("mousemove",(b)=>{this.x=b.x-Y,this.y=b.y-w}),h.addEventListener("mousedown",(b)=>{this.downX=Math.floor((b.x-Y)/z),this.downY=Math.floor((b.y-w)/k)-1,this.mouseDown=!0}),h.addEventListener("mouseup",(b)=>{this.upX=Math.floor((b.x-Y)/z),this.upY=Math.floor((b.y-w)/k)-1,this.shouldHandleMouseEvent=!0,this.mouseDown=!1})}}class N{canvas;ctx;brd;state;score;timeOut;mouse;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${Q}`),this.canvas.setAttribute("height",`${Z}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new g,this.state=V,this.score=0,this.timeOut=0,this.mouse=new C(this.canvas)}render(){this.ctx.drawImage(q.backGround,0,0,Q,Z),this.brd.isDirty=!1;let h,Y;for(h=0;h<K;++h)for(Y=0;Y<J;++Y){const b=this.brd.b[h][Y];if(b==-1)continue;if(this.mouse.mouseDown&&this.mouse.downX==Y&&this.mouse.downY==h)continue;this.ctx.drawImage(q.matchTypes[b],Y*z,(h+1)*k,z,k)}if(this.mouse.mouseDown)this.ctx.drawImage(q.matchTypes[this.brd.b[this.mouse.downY][this.mouse.downX]],this.mouse.x-z/2,this.mouse.y-k/2,z,k);const w=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(w,Q/2.7,k/2)}update(h){switch(this.state){case V:this.checkBoardState();break;case X:this.timeOutState(h);break;case $:this.playerState();break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}checkBoardState(){const h=this.brd.updateBoard();if(h===0)this.state=$;else this.score+=Math.max(0,h),this.timeOut=25,this.state=X}timeOutState(h){if(this.timeOut<=0)this.state=V;else this.timeOut-=h}playerState(){if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(this.mouse.downX,this.mouse.downY,this.mouse.upX,this.mouse.upY))this.timeOut=500,this.state=X}}}(()=>{q.init();const h=()=>{const Y=q.percentLoaded();if(Y!==1)document.getElementById("myProgress").style.width=`${Y}%`,window.requestAnimationFrame(h);else{document.getElementById("myProgress").hidden=!0;const w=new N;let b=(new Date()).getTime(),j=0;const U=(P)=>{j=P-b,b=P,w.update(j),w.render(),window.requestAnimationFrame(U)};window.requestAnimationFrame(U)}};window.requestAnimationFrame(h)})();
