var Q=880,i=640,z=6,J=7,P=106.66666666666667,j=106.66666666666667,U=0;var V=4,Z=5;class q{static matchTypes;static backGround;static size;static init(){const b=["apple","bread","coconut","green-thing","milk","orange","star"];this.matchTypes=[],this.size=b.length;for(let k=0;k<this.size;++k)this.matchTypes.push(new Image),this.matchTypes[k].src=`assets/${b[k]}.png`,this.matchTypes[k].width=P,this.matchTypes[k].height=j;this.backGround=new Image,this.backGround.src="assets/bg.png"}}class Y{b;WIDTH=8;HEIGHT=8;constructor(){this.b=[];for(let b=0;b<this.HEIGHT;++b){let k=[];for(let w=0;w<this.WIDTH;++w)k.push(Math.floor(Math.random()*q.size));this.b.push(k)}}runSwitch(b,k,w,h){let g=this.b[k][b];this.b[k][b]=this.b[h][w],this.b[h][w]=g;const X=this.connect3Exists();if(!X)g=this.b[k][b],this.b[k][b]=this.b[h][w],this.b[h][w]=g;return X}updateBoard(){if(this.fill())return-1;return this.findConnect3()}fill(){let b=!1;for(let k=0;k<z;++k)for(let w=J-1;w>=0;--w)if(this.b[w][k]===-1){if(w===0)this.b[w][k]=Math.floor(Math.random()*q.size),b=!0;else if(this.b[w-1][k]!==-1)this.b[w][k]=this.b[w-1][k],this.b[w-1][k]=-1,b=!0}return b}findConnect3(){let b,k,w,h=0,g=0;for(let X=0;X<J;++X)for(b=0;b<z;++b){if(w=this.b[X][b],w===-1)continue;for(h=0;h+b<z;++h)if(w!==this.b[X][h+b])break;if(h>=3){const $=b+h;for(;b<$;++b)this.b[X][b]=-1;return h}for(h=0;h+X<J;++h)if(w!==this.b[X+h][b])break;if(h>=3){const $=X+h;for(;X<$;++X)this.b[X][b]=-1;return h}}return 0}connect3Exists(){let b,k,w,h=0;for(let g=0;g<J;++g)for(b=0;b<z;++b){if(w=this.b[g][b],w===-1)continue;for(h=0;h+b<z;++h)if(w!==this.b[g][h+b])break;if(h>=3){const X=b+h;for(;b<X;++b)this.b[g][b]=-1;return!0}for(h=0;h+g<J;++h)if(w!==this.b[g+h][b])break;if(h>=3)return!0}return!1}}class v{downX;downY;upX;upY;shouldHandleMouseEvent;constructor(b){const{offsetLeft:k,offsetTop:w}=b;this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,b.addEventListener("mousedown",(h)=>{this.downX=Math.floor((h.x-k)/P),this.downY=Math.floor((h.y-w)/j)-1}),b.addEventListener("mouseup",(h)=>{this.upX=Math.floor((h.x-k)/P),this.upY=Math.floor((h.y-w)/j)-1,this.shouldHandleMouseEvent=!0})}}class F{canvas;ctx;brd;state;score;timeOut;mouse;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${Q}`),this.canvas.setAttribute("height",`${Q}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new Y,this.state=V,this.score=0,this.timeOut=0,this.mouse=new v(this.canvas)}update(b){switch(this.ctx.drawImage(q.backGround,0,0,i,Q),this.state){case V:const k=this.brd.updateBoard();if(k===0)this.state=U;else this.score+=Math.max(0,k),this.timeOut=25,this.state=Z;break;case Z:if(this.timeOut<=0)this.state=V;else this.timeOut-=b;break;case U:if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(this.mouse.downX,this.mouse.downY,this.mouse.upX,this.mouse.upY))this.timeOut=500,this.state=Z}break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}render(){let b,k;for(b=0;b<J;++b)for(k=0;k<z;++k){const h=this.brd.b[b][k];if(h==-1)continue;this.ctx.drawImage(q.matchTypes[h],k*P,(b+1)*j,P,j)}const w=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(w,i/2.7,j/2)}}(()=>{q.init();const b=new F;let k=(new Date()).getTime(),w=0;const h=(g)=>{w=g-k,k=g,b.update(w),b.render(),window.requestAnimationFrame(h)};window.requestAnimationFrame(h)})();
