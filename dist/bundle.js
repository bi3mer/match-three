var p=880,g=640,F=BigInt(6),X=BigInt(7),Z=F*X,z=640/Number(F),J=z,C=0;var L=4,W=5,j=7;class Q{static matchTypes;static backGround;static init(){const u=["apple","bread","coconut","green-thing","milk","orange","star"];this.matchTypes=[];for(let h=0;h<j;++h)this.matchTypes.push(new Image),this.matchTypes[h].src=`assets/${u[h]}.png`,this.matchTypes[h].width=Number(z),this.matchTypes[h].height=Number(J);this.backGround=new Image,this.backGround.src="assets/bg.png"}static percentLoaded(){let u=0;for(let h=0;h<j;++h)u+=Number(this.matchTypes[h].complete);return u+=Number(this.backGround.complete),u/(j+1)}}function R(u,h){return Math.floor(Math.random()*(h-u+1)+u)}function f(u){return u>=0?u:-u}var Y=BigInt(0),q=BigInt(1),V=BigInt(2);class P{b;boards;constructor(){this.b=[];for(let u=0;u<j;++u)this.b.push(BigInt(0))}runSwitch(u,h,k,w){if(u==k&&f(h-w)===q||h==w&&f(u-k)===q){const U=q<<u*X+h,K=q<<k*X+w,N=this.getType(u,h),$=this.getType(k,w);if(this.b[N]^=U,this.b[N]|=K,this.b[$]^=K,this.b[$]|=U,this.connect3Exists(N)||this.connect3Exists($))return!0;this.b[N]|=U,this.b[N]^=K,this.b[$]|=K,this.b[$]^=U}return!1}updateBoard(){if(this.fill())return-1;return this.findConnect3()}getType(u,h){const k=q<<u*X+h;for(let w=0;w<j;++w)if((this.b[w]&k)!=0)return w;return-1}validMoves(){return[]}fill(){let u=!1,h;for(let k=Z-q;k>=0;--k){for(h=BigInt(0);h<j;++h)if((this.b[h]&q<<k)!=0)break;if(h==j)if(u=!0,k%X==0){const w=R(0,Number(j)-1);this.b[w]|=q<<k}else{const w=q<<k-q;for(let U=0;U<j;++U)if((this.b[U]&w)!=0){this.b[U]|=q<<k,this.b[U]^=w;break}}}return u}findConnect3(){let u,h=0;for(let k=0;k<j;++k){const w=this.b[k],U=w&w<<X&w<<X*V,K=w&w<<q&w<<V;if(U>0){for(u=Y;u<Z;++u)if((U&q<<u)!==Y)this.b[k]^=q<<u,this.b[k]^=q<<u-X,this.b[k]^=q<<u-V*X,h+=3}if(K>0){for(u=Y;u<Z;++u)if((K&q<<u)!==Y)this.b[k]^=q<<u,this.b[k]^=q<<u-q,this.b[k]^=q<<u-V,h+=3}if(h>0)break}return h}connect3Exists(u){const h=this.b[u];if((h&h<<X&h<<X*V)>0)return!0;if((h&h<<q&h<<V)>0)return!0;return!1}}class l{mouseDown;x;y;downX;downY;upX;upY;shouldHandleMouseEvent;constructor(u){const{offsetLeft:h,offsetTop:k}=u;this.x=0,this.y=0,this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,u.addEventListener("mousemove",(w)=>{this.x=w.x-h,this.y=w.y-k}),u.addEventListener("mousedown",(w)=>{this.downX=Math.floor((w.x-h)/z),this.downY=Math.floor((w.y-k)/J)-1,this.mouseDown=!0}),u.addEventListener("mouseup",(w)=>{this.upX=Math.floor((w.x-h)/z),this.upY=Math.floor((w.y-k)/J)-1,this.shouldHandleMouseEvent=!0,this.mouseDown=!1})}}class c{canvas;ctx;brd;state;score;timeOut;mouse;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${g}`),this.canvas.setAttribute("height",`${p}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new P,this.state=L,this.score=0,this.timeOut=0,this.mouse=new l(this.canvas)}render(){this.ctx.drawImage(Q.backGround,0,0,g,p),this.brd.isDirty=!1;let u,h;for(u=0;u<X;++u)for(h=0;h<F;++h){const w=this.brd.getType(BigInt(h),BigInt(u));if(w==-1)continue;if(this.mouse.mouseDown&&this.mouse.downX==h&&this.mouse.downY==u)continue;this.ctx.drawImage(Q.matchTypes[w],h*z,(u+1)*J,z,J)}if(this.mouse.mouseDown)this.ctx.drawImage(Q.matchTypes[this.brd.getType(BigInt(this.mouse.downX),BigInt(this.mouse.downY))],this.mouse.x-z/2,this.mouse.y-J/2,z,J);const k=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(k,g/2.7,J/2)}update(u){switch(this.state){case L:this.checkBoardState();break;case W:this.timeOutState(u);break;case C:this.playerState();break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}checkBoardState(){const u=this.brd.updateBoard();if(u===0)this.state=C;else this.score+=Math.max(0,u),this.timeOut=25,this.state=W}timeOutState(u){if(this.timeOut<=0)this.state=L;else this.timeOut-=u}playerState(){if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(BigInt(this.mouse.downX),BigInt(this.mouse.downY),BigInt(this.mouse.upX),BigInt(this.mouse.upY)))this.timeOut=500,this.state=W}}}(()=>{Q.init();const u=()=>{const h=Q.percentLoaded();if(h!==1)document.getElementById("progress").value=h,window.requestAnimationFrame(u);else{document.getElementById("progress").hidden=!0;const k=new c;let w=(new Date()).getTime(),U=0;const K=(N)=>{U=N-w,w=N,k.update(U),k.render(),window.requestAnimationFrame(K)};window.requestAnimationFrame(K)}};window.requestAnimationFrame(u)})();
