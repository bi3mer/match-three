var Z=880,Q=640,J=6,U=7,C=106.66666666666667,j=106.66666666666667,$=0;var V=4,Y=5;class k{static matchTypes;static backGround;static size;static init(){const h=["apple","bread","coconut","green-thing","milk","orange","star"];this.matchTypes=[],this.size=h.length;for(let b=0;b<this.size;++b)this.matchTypes.push(new Image),this.matchTypes[b].src=`assets/${h[b]}.png`,this.matchTypes[b].width=C,this.matchTypes[b].height=j;this.backGround=new Image,this.backGround.src="assets/bg.png"}static percentLoaded(){let h=0;for(let b=0;b<this.size;++b)h+=Number(this.matchTypes[b].complete);return h+=Number(this.backGround.complete),h/(this.size+1)}}class g{b;isDirty;constructor(){this.isDirty=!0,this.b=[];for(let h=0;h<U;++h){let b=[];for(let w=0;w<J;++w)b.push(Math.floor(Math.random()*k.size));this.b.push(b)}this.b[U-1][0]=1,this.b[U-1][1]=1,this.b[U-1][2]=1,this.b[U-2][0]=1,this.b[U-3][0]=1}runSwitch(h,b,w,q){if(h==w&&Math.abs(b-q)==1||b==q&&Math.abs(h-w)==1){let z=this.b[b][h];this.b[b][h]=this.b[q][w],this.b[q][w]=z;const K=this.connect3Exists();if(!K)z=this.b[b][h],this.b[b][h]=this.b[q][w],this.b[q][w]=z;return K}return!1}updateBoard(){if(this.isDirty=!0,this.fill())return-1;return this.findConnect3()}fill(){let h=!1;for(let b=0;b<J;++b)for(let w=U-1;w>=0;--w)if(this.b[w][b]===-1){if(w===0)this.b[w][b]=Math.floor(Math.random()*k.size),h=!0;else if(this.b[w-1][b]!==-1)this.b[w][b]=this.b[w-1][b],this.b[w-1][b]=-1,h=!0}return h}findConnect3(){let h,b,w=0;for(let q=0;q<U;++q)for(h=0;h<J;++h){if(b=this.b[q][h],b==-1)continue;let z,K;for(let P=0;q+P<U;++P)for(let F=0;h+F<J;++F);}return 0}connect3Exists(){let h,b,w,q=0;for(let z=0;z<U;++z)for(h=0;h<J;++h){if(w=this.b[z][h],w===-1)continue;for(q=0;q+h<J;++q)if(w!==this.b[z][q+h])break;if(q>=3){const K=h+q;for(;h<K;++h)this.b[z][h]=-1;return!0}for(q=0;q+z<U;++q)if(w!==this.b[z+q][h])break;if(q>=3)return!0}return!1}}class X{mouseDown;x;y;downX;downY;upX;upY;shouldHandleMouseEvent;constructor(h){const{offsetLeft:b,offsetTop:w}=h;this.x=0,this.y=0,this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,h.addEventListener("mousemove",(q)=>{this.x=q.x-b,this.y=q.y-w}),h.addEventListener("mousedown",(q)=>{this.downX=Math.floor((q.x-b)/C),this.downY=Math.floor((q.y-w)/j)-1,this.mouseDown=!0}),h.addEventListener("mouseup",(q)=>{this.upX=Math.floor((q.x-b)/C),this.upY=Math.floor((q.y-w)/j)-1,this.shouldHandleMouseEvent=!0,this.mouseDown=!1})}}class i{canvas;ctx;brd;state;score;timeOut;mouse;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${Q}`),this.canvas.setAttribute("height",`${Z}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new g,this.state=V,this.score=0,this.timeOut=0,this.mouse=new X(this.canvas)}render(){this.ctx.drawImage(k.backGround,0,0,Q,Z),this.brd.isDirty=!1;let h,b;for(h=0;h<U;++h)for(b=0;b<J;++b){const q=this.brd.b[h][b];if(q==-1)continue;if(this.mouse.mouseDown&&this.mouse.downX==b&&this.mouse.downY==h)continue;this.ctx.drawImage(k.matchTypes[q],b*C,(h+1)*j,C,j)}if(this.mouse.mouseDown)this.ctx.drawImage(k.matchTypes[this.brd.b[this.mouse.downY][this.mouse.downX]],this.mouse.x-C/2,this.mouse.y-j/2,C,j);const w=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(w,Q/2.7,j/2)}update(h){switch(this.state){case V:this.checkBoardState();break;case Y:this.timeOutState(h);break;case $:this.playerState();break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}checkBoardState(){const h=this.brd.updateBoard();if(h===0)this.state=$;else this.score+=Math.max(0,h),this.timeOut=25,this.state=Y}timeOutState(h){if(this.timeOut<=0)this.state=V;else this.timeOut-=h}playerState(){if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(this.mouse.downX,this.mouse.downY,this.mouse.upX,this.mouse.upY))this.timeOut=500,this.state=Y}}}(()=>{k.init();const h=()=>{const b=k.percentLoaded();if(b!==1)document.getElementById("progress").value=b,window.requestAnimationFrame(h);else{document.getElementById("progress").hidden=!0;const w=new i;let q=(new Date()).getTime(),z=0;const K=(P)=>{z=P-q,q=P,w.update(z),w.render(),window.requestAnimationFrame(K)};window.requestAnimationFrame(K)}};window.requestAnimationFrame(h)})();
