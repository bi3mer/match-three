var Q=880,i=640,q=6,J=7,P=106.66666666666667,g=106.66666666666667,l=0;var V=4,Z=5;class j{static matchTypes;static backGround;static size;static init(){const h=["apple","bread","coconut","green-thing","milk","orange","star"];this.matchTypes=[],this.size=h.length;for(let b=0;b<this.size;++b)this.matchTypes.push(new Image),this.matchTypes[b].src=`assets/${h[b]}.png`,this.matchTypes[b].width=P,this.matchTypes[b].height=g;this.backGround=new Image,this.backGround.src="assets/bg.png"}}class U{b;WIDTH=8;HEIGHT=8;constructor(){this.b=[];for(let h=0;h<this.HEIGHT;++h){let b=[];for(let w=0;w<this.WIDTH;++w)b.push(Math.floor(Math.random()*j.size));this.b.push(b)}}runSwitch(h,b,w,k){let X=this.b[b][h];this.b[b][h]=this.b[k][w],this.b[k][w]=X;const z=this.connect3Exists();if(!z)X=this.b[b][h],this.b[b][h]=this.b[k][w],this.b[k][w]=X;return z}updateBoard(){if(this.fill())return-1;return this.findConnect3()}fill(){for(let h=0;h<q;++h)for(let b=0;b<J;++b)if(this.b[b][h]===-1){if(b===0)this.b[b][h]=Math.floor(Math.random()*j.size);else this.b[b][h]=this.b[b-1][h],this.b[b-1][h]=-1;return!0}return!1}findConnect3(){let h,b,w,k=0,X=0;for(let z=0;z<J;++z)for(h=0;h<q;++h){if(w=this.b[z][h],w===-1)continue;for(k=0;k+h<q;++k)if(w!==this.b[z][k+h])break;if(k>=3){const $=h+k;for(;h<$;++h)this.b[z][h]=-1;return k}for(k=0;k+z<J;++k)if(w!==this.b[z+k][h])break;if(k>=3){const $=z+k;for(;z<$;++z)this.b[z][h]=-1;return k}}return 0}connect3Exists(){let h,b,w,k=0;for(let X=0;X<J;++X)for(h=0;h<q;++h){if(w=this.b[X][h],w===-1)continue;for(k=0;k+h<q;++k)if(w!==this.b[X][k+h])break;if(k>=3){const z=h+k;for(;h<z;++h)this.b[X][h]=-1;return!0}for(k=0;k+X<J;++k)if(w!==this.b[X+k][h])break;if(k>=3)return!0}return!1}}class Y{downX;downY;upX;upY;shouldHandleMouseEvent;constructor(h){const{offsetLeft:b,offsetTop:w}=h;this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,h.addEventListener("mousedown",(k)=>{this.downX=Math.floor((k.x-b)/P),this.downY=Math.floor((k.y-w)/g)-1}),h.addEventListener("mouseup",(k)=>{this.upX=Math.floor((k.x-b)/P),this.upY=Math.floor((k.y-w)/g)-1,this.shouldHandleMouseEvent=!0})}}class v{canvas;ctx;brd;state;score;timeOut;mouse;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${Q}`),this.canvas.setAttribute("height",`${Q}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new U,this.state=V,this.score=0,this.timeOut=0,this.mouse=new Y(this.canvas)}update(h){switch(this.ctx.drawImage(j.backGround,0,0,i,Q),this.state){case V:const b=this.brd.updateBoard();if(b===0)this.state=l;else this.score+=Math.max(0,b),this.timeOut=25,this.state=Z;break;case Z:if(this.timeOut<=0)this.state=V;else this.timeOut-=h;break;case l:if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(this.mouse.downX,this.mouse.downY,this.mouse.upX,this.mouse.upY))this.timeOut=500,this.state=Z}break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}render(){let h,b;for(h=0;h<J;++h)for(b=0;b<q;++b){const k=this.brd.b[h][b];if(k==-1)continue;this.ctx.drawImage(j.matchTypes[k],b*P,(h+1)*g,P,g)}const w=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(w,i/2.7,g/2)}}(()=>{j.init();const h=new v;let b=(new Date()).getTime(),w=0;const k=(X)=>{w=X-b,b=X,h.update(w),h.render(),window.requestAnimationFrame(k)};window.requestAnimationFrame(k)})();
