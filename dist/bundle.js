var V=880,J=640,K=BigInt(6),z=BigInt(7),$=K*z,q=640/Number(K),u=q,F=0;var N=4,Q=5,U=7;class X{static matchTypes;static backGround;static init(){const h=["apple","bread","coconut","green-thing","milk","orange","star"];this.matchTypes=[];for(let w=0;w<U;++w)this.matchTypes.push(new Image),this.matchTypes[w].src=`assets/${h[w]}.png`,this.matchTypes[w].width=Number(q),this.matchTypes[w].height=Number(u);this.backGround=new Image,this.backGround.src="assets/bg.png"}static percentLoaded(){let h=0;for(let w=0;w<U;++w)h+=Number(this.matchTypes[w].complete);return h+=Number(this.backGround.complete),h/(U+1)}}function y(h,w){return Math.floor(Math.random()*(w-h+1)+h)}class Z{b;boards;constructor(){this.b=[];for(let h=0;h<U;++h)this.b.push(BigInt(0))}runSwitch(h,w,k,g){return!1}updateBoard(){if(this.fill())return-1;return this.findConnect3()}getType(h,w){const k=BigInt(1)<<h*z+w;for(let g=0;g<U;++g)if((this.b[g]&k)!=0)return g;return-1}validMoves(){return[]}fill(){let h=!1,w;console.log($);for(let k=$-BigInt(1);k>=0;--k){for(w=BigInt(0);w<U;++w)if((this.b[w]&BigInt(1)<<k)!=0)break;if(w==U)if(h=!0,k%z==0){const g=y(0,Number(U)-1);this.b[g]|=BigInt(1)<<k}else{const g=BigInt(1)<<k-BigInt(1);for(let j=0;j<U;++j)if((this.b[j]&g)!=0){this.b[j]|=BigInt(1)<<k,this.b[j]^=g;break}}}return h}findConnect3(){for(let h=0;h<X.size;++h){const w=this.b[h],k=w&w<<BigInt(7)&w<<BigInt(14),g=w&w<<BigInt(1)&w<<BigInt(2);if(k>0);if(g>0);}return 0}connect3Exists(){return!1}}class L{mouseDown;x;y;downX;downY;upX;upY;shouldHandleMouseEvent;constructor(h){const{offsetLeft:w,offsetTop:k}=h;this.x=0,this.y=0,this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,h.addEventListener("mousemove",(g)=>{this.x=g.x-w,this.y=g.y-k}),h.addEventListener("mousedown",(g)=>{this.downX=Math.floor((g.x-w)/q),this.downY=Math.floor((g.y-k)/u)-1,this.mouseDown=!0}),h.addEventListener("mouseup",(g)=>{this.upX=Math.floor((g.x-w)/q),this.upY=Math.floor((g.y-k)/u)-1,this.shouldHandleMouseEvent=!0,this.mouseDown=!1})}}class W{canvas;ctx;brd;state;score;timeOut;mouse;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${J}`),this.canvas.setAttribute("height",`${V}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new Z,this.state=N,this.score=0,this.timeOut=0,this.mouse=new L(this.canvas)}render(){this.ctx.drawImage(X.backGround,0,0,J,V),this.brd.isDirty=!1;let h,w;for(h=0;h<z;++h)for(w=0;w<K;++w){const g=this.brd.getType(BigInt(w),BigInt(h));if(g==-1)continue;if(this.mouse.mouseDown&&this.mouse.downX==w&&this.mouse.downY==h)continue;this.ctx.drawImage(X.matchTypes[g],w*q,(h+1)*u,q,u)}if(this.mouse.mouseDown)this.ctx.drawImage(X.matchTypes[this.brd.getType(BigInt(this.mouse.downX),BigInt(this.mouse.downY))],this.mouse.x-q/2,this.mouse.y-u/2,q,u);const k=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(k,J/2.7,u/2)}update(h){switch(this.state){case N:this.checkBoardState();break;case Q:this.timeOutState(h);break;case F:this.playerState();break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}checkBoardState(){const h=this.brd.updateBoard();if(h===0)this.state=F;else this.score+=Math.max(0,h),this.timeOut=25,this.state=Q}timeOutState(h){if(this.timeOut<=0)this.state=N;else this.timeOut-=h}playerState(){if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(this.mouse.downX,this.mouse.downY,this.mouse.upX,this.mouse.upY))this.timeOut=500,this.state=Q}}}(()=>{X.init();const h=()=>{const w=X.percentLoaded();if(w!==1)document.getElementById("progress").value=w,window.requestAnimationFrame(h);else{document.getElementById("progress").hidden=!0;const k=new W;let g=(new Date()).getTime(),j=0;const O=(r)=>{j=r-g,g=r,k.update(j),k.render(),window.requestAnimationFrame(O)};window.requestAnimationFrame(O)}};window.requestAnimationFrame(h)})();
