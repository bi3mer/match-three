var p=880,W=640,g=BigInt(6),L=BigInt(7),v=g*L,$=640/Number(g),u=$,M=0;var D=4,R=5,P=6,Z=7,C=1000,b=1000;class U{static matchTypes;static backGround;static types=["apple","bread","coconut","green-thing","milk","orange","star"];static init(){this.matchTypes=[];for(let w=0;w<Z;++w)this.matchTypes.push(new Image),this.matchTypes[w].src=`assets/${this.types[w]}.png`,this.matchTypes[w].width=Number($),this.matchTypes[w].height=Number(u);this.backGround=new Image,this.backGround.src="assets/bg.png"}static percentLoaded(){let w=0;for(let h=0;h<Z;++h)w+=Number(this.matchTypes[h].complete);return w+=Number(this.backGround.complete),w/(Z+1)}}function l(w,h){return Math.floor(Math.random()*(h-w+1)+w)}function S(w,h){return Math.random()*(h-w+1)+w}function E(){return Math.sign(Math.random()-0.5)}function X(w){return w>=BigInt(0)?w:BigInt(-w)}function B(w){const h=w<<z*F&w<<z*r,q=w&w<<z*F,k=w&h,J=h&w<<z*_,K=w<<z-f&h,Q=h&w<<z*y-f,j=w<<z+f&h,Y=h&w<<z*y+f,T=q&w<<z+f,s=q&w<<z-f,O=w>>f&w>>F,t=w&w>>F,o=w<<z&O,i=w<<f&O,n=w>>z&O,x=w>>r-z&O,d=w>>y&O,a=w>>z+r&O,G=w>>f-z&t,e=w>>f+z&t;return(k|J|K|Q|j|Y|T|s|o|i|n|x|d|a|G|e)>V}var V=BigInt(0),f=BigInt(1),F=BigInt(2),r=BigInt(3),y=BigInt(4),_=BigInt(5),z=BigInt(9);class c{boards;constructor(){this.boards=[];for(let w=0;w<Z;++w)this.boards.push(V)}clear(){for(let w=0;w<Z;++w)this.boards[w]=V}validMoveExists(){for(let w=0;w<Z;++w)if(B(this.boards[w]))return console.log("Match found for",U.types[w],new Date),!0;return!1}runSwitch(w,h,q,k){if(w==q&&X(h-k)===f||h==k&&X(w-q)===f){const J=f<<w*z+h,K=f<<q*z+k,Q=this.getType(w,h),j=this.getType(q,k);if(this.boards[Q]^=J,this.boards[Q]|=K,this.boards[j]^=K,this.boards[j]|=J,this.connect3Exists(Q)||this.connect3Exists(j))return!0;this.boards[Q]|=J,this.boards[Q]^=K,this.boards[j]|=K,this.boards[j]^=J}return!1}updateBoard(){if(this.fill())return-1;return this.findConnect3()}getType(w,h){const q=f<<w*z+h;for(let k=0;k<Z;++k)if((this.boards[k]&q)!=V)return k;return-1}validMoves(){return[]}fill(){let w=!1,h;for(let q=V;q<L;++q)for(let k=V;k<g;++k){const J=q+k*z;for(h=0;h<Z;++h)if((this.boards[h]&f<<J)!=V)break;if(h==Z)if(w=!0,q==V){const K=l(0,Number(Z)-1);this.boards[K]|=f<<J}else{const K=f<<J-f;for(let Q=0;Q<Z;++Q)if((this.boards[Q]&K)!=V){this.boards[Q]|=f<<J,this.boards[Q]^=K;break}}}return w}findConnect3(){let w,h,q,k=0;for(let J=0;J<Z;++J){const K=this.boards[J],Q=K&K<<z&K<<z*F,j=K&K<<f&K<<F;if(Q>0)for(h=V;h<g;++h){let Y=h*z;for(q=V;q<L;++q)if(w=Y+q,(Q&f<<w)!==V)this.boards[J]&=~(f<<w),this.boards[J]&=~(f<<w-z),this.boards[J]&=~(f<<w-F*z),k+=3}if(j>0)for(h=V;h<g;++h){let Y=h*z;for(q=V;q<L;++q)if(w=Y+q,(j&f<<w)!==V)this.boards[J]&=~(f<<w),this.boards[J]&=~(f<<w-f),this.boards[J]&=~(f<<w-F),k+=3}if(k>0)break}return k}connect3Exists(w){const h=this.boards[w];return(h&h<<f&h<<F)>0||(h&h<<z&h<<z*F)>0}}class A{particles;acceleration;elapsed;constructor(){this.elapsed=0,this.particles=[],this.acceleration=[];for(let w=0;w<C;++w)this.particles.push([0,0]),this.acceleration.push([0,0])}reset(){this.elapsed=0;for(let w=0;w<C;++w)this.particles[w][0]=W/2,this.particles[w][1]=p/2,this.acceleration[w][0]=S(0.1,10)*E(),this.acceleration[w][1]=S(0.1,10)*E()}update(w){for(let h=0;h<C;++h)this.particles[h][0]+=this.acceleration[h][0],this.particles[h][1]+=this.acceleration[h][1];return this.elapsed+=w,this.elapsed>b}render(w){w.fillStyle="white";for(let h=0;h<C;++h)w.beginPath(),w.arc(this.particles[h][0],this.particles[h][1],10,0,2*Math.PI),w.fill()}}class m{mouseDown;x;y;downX;downY;upX;upY;shouldHandleMouseEvent;constructor(w){this.x=0,this.y=0,this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,w.addEventListener("mousemove",(h)=>{this.x=h.x-w.offsetLeft,this.y=h.y-w.offsetTop}),w.addEventListener("mousedown",(h)=>{this.downX=Math.floor((h.x-w.offsetLeft)/$),this.downY=Math.floor((h.y-w.offsetTop)/u)-1,this.mouseDown=!0}),w.addEventListener("mouseup",(h)=>{this.upX=Math.floor((h.x-w.offsetLeft)/$),this.upY=Math.floor((h.y-w.offsetTop)/u)-1,this.shouldHandleMouseEvent=!0,this.mouseDown=!1})}}class N{static sounds=[];static init(){this.sounds.push(new Audio("assets/success_1.wav")),this.sounds.push(new Audio("assets/success_2.wav")),this.sounds.push(new Audio("assets/success_3.wav")),this.sounds.push(new Audio("assets/success_4.wav")),this.sounds.push(new Audio("assets/explosion.wav"))}static isLoaded(){for(let w=0;w<this.sounds.length;++w)if(!this.sounds[w].readyState)return!1;return!0}static playMatchSound(){const w=l(0,3);this.sounds[w].currentTime=0,this.sounds[w].play()}static playExplosion(){this.sounds[4].currentTime=0,this.sounds[4].play()}}class H{canvas;ctx;brd;state;score;timeOut;mouse;explosion;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${W}`),this.canvas.setAttribute("height",`${p}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new c,this.state=D,this.score=0,this.timeOut=0,this.explosion=new A,this.mouse=new m(this.canvas)}render(){this.ctx.drawImage(U.backGround,0,0,W,p);let w,h;for(w=0;w<L;++w)for(h=0;h<g;++h){const k=this.brd.getType(BigInt(h),BigInt(w));if(k==-1)continue;if(this.mouse.mouseDown&&this.mouse.downX==h&&this.mouse.downY==w)continue;this.ctx.drawImage(U.matchTypes[k],h*$,(w+1)*u,$,u)}if(this.mouse.mouseDown){const k=this.brd.getType(BigInt(this.mouse.downX),BigInt(this.mouse.downY));if(k!==-1)this.ctx.drawImage(U.matchTypes[k],this.mouse.x-$/2,this.mouse.y-u/2,$,u)}if(this.state===P)this.explosion.render(this.ctx);const q=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(q,W/2.7,u/2)}update(w){switch(this.state){case D:this.checkBoardState();break;case R:this.timeOutState(w);break;case M:this.playerState();break;case P:this.explosionState(w);break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}checkBoardState(){const w=this.brd.updateBoard();if(w===0)if(this.brd.validMoveExists())this.state=M;else this.brd.clear(),this.score+=Number(v),this.state=P,this.explosion.reset(),N.playExplosion();else if(this.score+=Math.max(0,w),this.timeOut=25,this.state=R,w!==-1)N.playMatchSound()}timeOutState(w){if(this.timeOut<=0)this.state=D;else this.timeOut-=w}playerState(){if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(BigInt(this.mouse.downX),BigInt(this.mouse.downY),BigInt(this.mouse.upX),BigInt(this.mouse.upY)))this.timeOut=500,this.state=R}}explosionState(w){if(this.explosion.update(w))this.timeOut=250,this.state=R}}(()=>{U.init(),N.init();const w=()=>{const h=U.percentLoaded();if(h!==1&&N.isLoaded())document.getElementById("progress").value=h,window.requestAnimationFrame(w);else{document.getElementById("progress").hidden=!0;const q=new H;let k=(new Date()).getTime(),J=0;const K=(Q)=>{J=Q-k,k=Q,q.update(J),q.render(),window.requestAnimationFrame(K)};window.requestAnimationFrame(K)}};window.requestAnimationFrame(w)})();
