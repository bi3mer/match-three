var V=720,P=720,w=8,z=7,J=90,k=90,g=0;var Z=4,$=5;class Q{static images;static size;static init(){const i=["apple","bread","coconut","green-thing","milk","orange","star"];this.images=[],this.size=i.length;for(let X=0;X<this.size;++X)this.images.push(new Image),this.images[X].src=`assets/${i[X]}.png`,this.images[X].width=J,this.images[X].height=k}}class U{b;WIDTH=8;HEIGHT=8;constructor(){this.b=[];for(let i=0;i<this.HEIGHT;++i){let X=[];for(let j=0;j<this.WIDTH;++j)X.push(Math.floor(Math.random()*Q.size));this.b.push(X)}}runSwitch(i,X,j,h){let b=this.b[X][i];this.b[X][i]=this.b[h][j],this.b[h][j]=b;const q=this.connect3Exists();if(!q)b=this.b[X][i],this.b[X][i]=this.b[h][j],this.b[h][j]=b;return q}updateBoard(){if(this.fill())return-1;return this.findConnect3()}fill(){for(let i=0;i<w;++i)for(let X=0;X<z;++X)if(this.b[X][i]===-1){if(X===0)this.b[X][i]=Math.floor(Math.random()*Q.size);else this.b[X][i]=this.b[X-1][i],this.b[X-1][i]=-1;return!0}return!1}findConnect3(){let i,X,j,h=0;for(let b=0;b<z;++b)for(i=0;i<w;++i){if(j=this.b[b][i],j===-1)continue;for(h=0;h+i<w;++h)if(j!==this.b[b][h+i])break;if(h>=3){const q=i+h;for(;i<q;++i)this.b[b][i]=-1;return h}for(h=0;h+b<z;++h)if(j!==this.b[b+h][i])break;if(h>=3){const q=b+h;for(;b<q;++b)this.b[b][i]=-1;return h}}return 0}connect3Exists(){let i,X,j,h=0;for(let b=0;b<z;++b)for(i=0;i<w;++i){if(j=this.b[b][i],j===-1)continue;for(h=0;h+i<w;++h)if(j!==this.b[b][h+i])break;if(h>=3){const q=i+h;for(;i<q;++i)this.b[b][i]=-1;return!0}for(h=0;h+b<z;++h)if(j!==this.b[b+h][i])break;if(h>=3)return!0}return!1}}class Y{downX;downY;upX;upY;shouldHandleMouseEvent;constructor(i){const{offsetLeft:X,offsetTop:j}=i;this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,i.addEventListener("mousedown",(h)=>{this.downX=Math.floor((h.x-X)/J),this.downY=Math.floor((h.y-j)/k)-1}),i.addEventListener("mouseup",(h)=>{this.upX=Math.floor((h.x-X)/J),this.upY=Math.floor((h.y-j)/k)-1,this.shouldHandleMouseEvent=!0})}}class F{canvas;ctx;brd;state;score;timeOut;mouse;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${V}`),this.canvas.setAttribute("height",`${V}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new U,this.state=Z,this.score=0,this.timeOut=0,this.mouse=new Y(this.canvas)}update(i){switch(this.ctx.clearRect(0,0,P,V),this.state){case Z:const X=this.brd.updateBoard();if(X===0)this.state=g;else this.score+=Math.max(0,X),this.timeOut=25,this.state=$;break;case $:if(this.timeOut<=0)this.state=Z;else this.timeOut-=i;break;case g:if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(this.mouse.downX,this.mouse.downY,this.mouse.upX,this.mouse.upY))this.timeOut=500,this.state=$}break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}render(){let i,X;for(i=0;i<z;++i)for(X=0;X<w;++X){const h=this.brd.b[i][X];if(h==-1)continue;this.ctx.drawImage(Q.images[h],X*J,(i+1)*k,J,k)}const j=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(j,P/2.7,k/2)}}(()=>{Q.init();const i=new F;let X=(new Date()).getTime(),j=0;const h=(b)=>{j=b-X,X=b,i.update(j),i.render(),window.requestAnimationFrame(h)};window.requestAnimationFrame(h)})();
