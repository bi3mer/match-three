var X=880,U=640,Q=6,V=7,z=106.66666666666667,q=106.66666666666667,Y=0;var Z=4,$=5;class J{static matchTypes;static backGround;static size;static init(){const h=["apple","bread","coconut","green-thing","milk","orange","star"];this.matchTypes=[],this.size=h.length;for(let w=0;w<this.size;++w)this.matchTypes.push(new Image),this.matchTypes[w].src=`assets/${h[w]}.png`,this.matchTypes[w].width=z,this.matchTypes[w].height=q;this.backGround=new Image,this.backGround.src="assets/bg.png"}}class F{b;isDirty;constructor(){this.isDirty=!0,this.b=[];for(let h=0;h<V;++h){let w=[];for(let g=0;g<Q;++g)w.push(Math.floor(Math.random()*J.size));this.b.push(w)}}runSwitch(h,w,g,b){let k=this.b[w][h];this.b[w][h]=this.b[b][g],this.b[b][g]=k;const j=this.connect3Exists();if(!j)k=this.b[w][h],this.b[w][h]=this.b[b][g],this.b[b][g]=k;return j}updateBoard(){if(this.isDirty=!0,this.fill())return-1;return this.findConnect3()}fill(){let h=!1;for(let w=0;w<Q;++w)for(let g=V-1;g>=0;--g)if(this.b[g][w]===-1){if(g===0)this.b[g][w]=Math.floor(Math.random()*J.size),h=!0;else if(this.b[g-1][w]!==-1)this.b[g][w]=this.b[g-1][w],this.b[g-1][w]=-1,h=!0}return h}findConnect3(){let h,w,g,b=0,k=0;for(let j=0;j<V;++j)for(h=0;h<Q;++h){if(g=this.b[j][h],g===-1)continue;for(b=0;b+h<Q;++b)if(g!==this.b[j][b+h])break;if(b>=3){const P=h+b;for(;h<P;++h)this.b[j][h]=-1;return b}for(b=0;b+j<V;++b)if(g!==this.b[j+b][h])break;if(b>=3){const P=j+b;for(;j<P;++j)this.b[j][h]=-1;return b}}return 0}connect3Exists(){let h,w,g,b=0;for(let k=0;k<V;++k)for(h=0;h<Q;++h){if(g=this.b[k][h],g===-1)continue;for(b=0;b+h<Q;++b)if(g!==this.b[k][b+h])break;if(b>=3){const j=h+b;for(;h<j;++h)this.b[k][h]=-1;return!0}for(b=0;b+k<V;++b)if(g!==this.b[k+b][h])break;if(b>=3)return!0}return!1}}class K{mouseDown;x;y;downX;downY;upX;upY;shouldHandleMouseEvent;constructor(h){const{offsetLeft:w,offsetTop:g}=h;this.x=0,this.y=0,this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,h.addEventListener("mousemove",(b)=>{this.x=b.x-w,this.y=b.y-g}),h.addEventListener("mousedown",(b)=>{this.downX=Math.floor((b.x-w)/z),this.downY=Math.floor((b.y-g)/q)-1,this.mouseDown=!0}),h.addEventListener("mouseup",(b)=>{this.upX=Math.floor((b.x-w)/z),this.upY=Math.floor((b.y-g)/q)-1,this.shouldHandleMouseEvent=!0,this.mouseDown=!1})}}class i{canvas;ctx;brd;state;score;timeOut;mouse;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${X}`),this.canvas.setAttribute("height",`${X}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new F,this.state=Z,this.score=0,this.timeOut=0,this.mouse=new K(this.canvas)}render(){this.ctx.drawImage(J.backGround,0,0,U,X),this.brd.isDirty=!1;let h,w;for(h=0;h<V;++h)for(w=0;w<Q;++w){const b=this.brd.b[h][w];if(b==-1)continue;if(this.mouse.mouseDown&&this.mouse.downX==w&&this.mouse.downY==h)continue;this.ctx.drawImage(J.matchTypes[b],w*z,(h+1)*q,z,q)}if(this.mouse.mouseDown)this.ctx.drawImage(J.matchTypes[this.brd.b[this.mouse.downY][this.mouse.downX]],this.mouse.x-z/2,this.mouse.y-q/2,z,q);const g=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(g,U/2.7,q/2)}update(h){switch(this.state){case Z:this.checkBoardState();break;case $:this.timeOutState(h);break;case Y:this.playerState();break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}checkBoardState(){const h=this.brd.updateBoard();if(h===0)this.state=Y;else this.score+=Math.max(0,h),this.timeOut=25,this.state=$}timeOutState(h){if(this.timeOut<=0)this.state=Z;else this.timeOut-=h}playerState(){if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(this.mouse.downX,this.mouse.downY,this.mouse.upX,this.mouse.upY))this.timeOut=500,this.state=$}}}(()=>{J.init();const h=new i;let w=(new Date()).getTime(),g=0;const b=(k)=>{g=k-w,w=k,h.update(g),h.render(),window.requestAnimationFrame(b)};window.requestAnimationFrame(b)})();
