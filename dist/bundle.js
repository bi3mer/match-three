var p=880,W=640,N=BigInt(6),O=BigInt(7),b=N*O,u=640/Number(N),j=u,M=0;var D=4,R=5,P=6,$=7,C=1000,t=1000;class F{static matchTypes;static backGround;static types=["apple","bread","coconut","green-thing","milk","orange","star"];static init(){this.matchTypes=[];for(let h=0;h<$;++h)this.matchTypes.push(new Image),this.matchTypes[h].src=`assets/${this.types[h]}.png`,this.matchTypes[h].width=Number(u),this.matchTypes[h].height=Number(j);this.backGround=new Image,this.backGround.src="assets/bg.png"}static percentLoaded(){let h=0;for(let w=0;w<$;++w)h+=Number(this.matchTypes[w].complete);return h+=Number(this.backGround.complete),h/($+1)}}function l(h,w){return Math.floor(Math.random()*(w-h+1)+h)}function S(h,w){return Math.random()*(w-h+1)+h}function c(){return Math.sign(Math.random()-0.5)}function E(h){return h>=BigInt(0)?h:BigInt(-h)}function B(h){const w=h<<J*g&h<<J*v,q=h&h<<J*g,k=h&w,K=w&h<<J*_,Q=h<<J-z&w,V=w&h<<J*X-z,U=h<<J+z&w,f=w&h<<J*X+z,s=q&h<<J+z,T=q&h<<J-z,L=h>>z&h>>g,H=h&h>>g,n=h<<J&L,o=h<<z&L,i=h>>J&L,a=h>>v-J&L,x=h>>X&L,d=h>>J+v&L,G=h>>z-J&H,e=h>>z+J&H;return(k|K|Q|V|U|f|s|T|n|o|i|a|x|d|G|e)>Z}var Z=BigInt(0),z=BigInt(1),g=BigInt(2),v=BigInt(3),X=BigInt(4),_=BigInt(5),J=BigInt(9);class r{boards;constructor(){this.boards=[];for(let h=0;h<$;++h)this.boards.push(Z)}clear(){for(let h=0;h<$;++h)this.boards[h]=Z}validMoveExists(){for(let h=0;h<$;++h)if(B(this.boards[h]))return console.log("Match found for",F.types[h],new Date),!0;return!1}runSwitch(h,w,q,k){if(h==q&&E(w-k)===z||w==k&&E(h-q)===z){const K=z<<h*J+w,Q=z<<q*J+k,V=this.getType(h,w),U=this.getType(q,k);if(this.boards[V]^=K,this.boards[V]|=Q,this.boards[U]^=Q,this.boards[U]|=K,this.connect3Exists(V)||this.connect3Exists(U))return!0;this.boards[V]|=K,this.boards[V]^=Q,this.boards[U]|=Q,this.boards[U]^=K}return!1}updateBoard(){if(this.fill())return-1;return this.findConnect3()}getType(h,w){const q=z<<h*J+w;for(let k=0;k<$;++k)if((this.boards[k]&q)!=Z)return k;return-1}validMoves(){return[]}fill(){let h=!1,w;for(let q=Z;q<O;++q)for(let k=Z;k<N;++k){const K=q+k*J;for(w=0;w<$;++w)if((this.boards[w]&z<<K)!=Z)break;if(w==$)if(h=!0,q==Z){const Q=l(0,Number($)-1);this.boards[Q]|=z<<K}else{const Q=z<<K-z;for(let V=0;V<$;++V)if((this.boards[V]&Q)!=Z){this.boards[V]|=z<<K,this.boards[V]^=Q;break}}}return h}findConnect3(){let h,w,q,k=0;for(let K=0;K<$;++K){const Q=this.boards[K],V=Q&Q<<J&Q<<J*g,U=Q&Q<<z&Q<<g;if(V>0)for(w=Z;w<N;++w){let f=w*J;for(q=Z;q<O;++q)if(h=f+q,(V&z<<h)!==Z)this.boards[K]&=~(z<<h),this.boards[K]&=~(z<<h-J),this.boards[K]&=~(z<<h-g*J),k+=3}if(U>0)for(w=Z;w<N;++w){let f=w*J;for(q=Z;q<O;++q)if(h=f+q,(U&z<<h)!==Z)this.boards[K]&=~(z<<h),this.boards[K]&=~(z<<h-z),this.boards[K]&=~(z<<h-g),k+=3}if(k>0)break}return k}connect3Exists(h){const w=this.boards[h];return(w&w<<z&w<<g)>0||(w&w<<J&w<<J*g)>0}}class y{particles;acceleration;elapsed;constructor(){this.elapsed=0,this.particles=[],this.acceleration=[];for(let h=0;h<C;++h)this.particles.push([0,0]),this.acceleration.push([0,0])}reset(){this.elapsed=0;for(let h=0;h<C;++h)this.particles[h][0]=W/2,this.particles[h][1]=p/2,this.acceleration[h][0]=S(0.1,10)*c(),this.acceleration[h][1]=S(0.1,10)*c()}update(h){for(let w=0;w<C;++w)this.particles[w][0]+=this.acceleration[w][0],this.particles[w][1]+=this.acceleration[w][1];return this.elapsed+=h,this.elapsed>t}render(h){h.fillStyle="white";for(let w=0;w<C;++w)h.beginPath(),h.arc(this.particles[w][0],this.particles[w][1],10,0,2*Math.PI),h.fill()}}class A{mouseDown;x;y;downX;downY;upX;upY;shouldHandleMouseEvent;constructor(h){const{offsetLeft:w,offsetTop:q}=h;this.x=0,this.y=0,this.downX=0,this.downY=0,this.upX=0,this.upY=0,this.shouldHandleMouseEvent=!1,h.addEventListener("mousemove",(k)=>{this.x=k.x-w,this.y=k.y-q}),h.addEventListener("mousedown",(k)=>{this.downX=Math.floor((k.x-w)/u),this.downY=Math.floor((k.y-q)/j)-1,this.mouseDown=!0}),h.addEventListener("mouseup",(k)=>{this.upX=Math.floor((k.x-w)/u),this.upY=Math.floor((k.y-q)/j)-1,this.shouldHandleMouseEvent=!0,this.mouseDown=!1})}}class Y{static sounds=[];static init(){this.sounds.push(new Audio("assets/success_1.wav")),this.sounds.push(new Audio("assets/success_2.wav")),this.sounds.push(new Audio("assets/success_3.wav")),this.sounds.push(new Audio("assets/success_4.wav")),this.sounds.push(new Audio("assets/explosion.wav"))}static isLoaded(){for(let h=0;h<this.sounds.length;++h)if(!this.sounds[h].readyState)return!1;return!0}static playMatchSound(){const h=l(0,3);this.sounds[h].currentTime=0,this.sounds[h].play()}static playExplosion(){this.sounds[4].currentTime=0,this.sounds[4].play()}}class m{canvas;ctx;brd;state;score;timeOut;mouse;explosion;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.setAttribute("width",`${W}`),this.canvas.setAttribute("height",`${p}`),document.getElementById("canvashere").appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.brd=new r,this.state=D,this.score=0,this.timeOut=0,this.explosion=new y,this.mouse=new A(this.canvas)}render(){this.ctx.drawImage(F.backGround,0,0,W,p);let h,w;for(h=0;h<O;++h)for(w=0;w<N;++w){const k=this.brd.getType(BigInt(w),BigInt(h));if(k==-1)continue;if(this.mouse.mouseDown&&this.mouse.downX==w&&this.mouse.downY==h)continue;this.ctx.drawImage(F.matchTypes[k],w*u,(h+1)*j,u,j)}if(this.mouse.mouseDown){const k=this.brd.getType(BigInt(this.mouse.downX),BigInt(this.mouse.downY));if(k!==-1)this.ctx.drawImage(F.matchTypes[k],this.mouse.x-u/2,this.mouse.y-j/2,u,j)}if(this.state===P)this.explosion.render(this.ctx);const q=`Score: ${this.score}`;this.ctx.fillStyle="white",this.ctx.font="40px monospace",this.ctx.fillText(q,W/2.7,j/2)}update(h){switch(this.state){case D:this.checkBoardState();break;case R:this.timeOutState(h);break;case M:this.playerState();break;case P:this.explosionState(h);break;default:console.error(`Unhandled state '${this.state}'. The game is ruined.`);break}}checkBoardState(){const h=this.brd.updateBoard();if(h===0)if(this.brd.validMoveExists())this.state=M;else this.brd.clear(),this.score+=Number(b),this.state=P,this.explosion.reset(),Y.playExplosion();else if(this.score+=Math.max(0,h),this.timeOut=25,this.state=R,h!==-1)Y.playMatchSound()}timeOutState(h){if(this.timeOut<=0)this.state=D;else this.timeOut-=h}playerState(){if(this.mouse.shouldHandleMouseEvent){if(this.mouse.shouldHandleMouseEvent=!1,this.brd.runSwitch(BigInt(this.mouse.downX),BigInt(this.mouse.downY),BigInt(this.mouse.upX),BigInt(this.mouse.upY)))this.timeOut=500,this.state=R}}explosionState(h){if(this.explosion.update(h))this.timeOut=250,this.state=R}}(()=>{F.init(),Y.init();const h=()=>{const w=F.percentLoaded();if(w!==1&&Y.isLoaded())document.getElementById("progress").value=w,window.requestAnimationFrame(h);else{document.getElementById("progress").hidden=!0;const q=new m;let k=(new Date()).getTime(),K=0;const Q=(V)=>{K=V-k,k=V,q.update(K),q.render(),window.requestAnimationFrame(Q)};window.requestAnimationFrame(Q)}};window.requestAnimationFrame(h)})();
